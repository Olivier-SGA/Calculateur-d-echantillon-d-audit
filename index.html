<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculateur d'√©chantillon ‚Äì Audit (MUS / Al√©atoire / Discovery)</title>
<style>
  :root{
    --bg:#f8fafc; --panel:#ffffff; --muted:#64748b; --text:#1e293b;
    --accent:#3b82f6; --green:#10b981; --red:#ef4444; --yellow:#f59e0b;
    --line:#e2e8f0; --hover:#f1f5f9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans";
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:var(--text); min-height:100vh;
  }
  header{
    padding:24px 20px; border-bottom:1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    position:sticky; top:0; z-index:10;
  }
  header .title{display:flex; align-items:center; gap:16px; flex-wrap:wrap}
  header h1{margin:0; font-size:24px; font-weight:700; color:white; text-shadow:0 2px 4px rgba(0,0,0,0.3)}
  header .badge{
    font-size:13px; padding:6px 12px; background:rgba(255,255,255,0.2); 
    border:1px solid rgba(255,255,255,0.3); border-radius:20px; color:white;
    backdrop-filter: blur(5px);
  }
  main{max-width:1200px; margin:32px auto; padding:0 20px; display:grid; grid-template-columns: 1fr 1fr; gap:24px}
  @media (max-width: 1024px){ main{grid-template-columns:1fr; gap:20px} }
  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:16px; 
    padding:24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover{transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.15)}
  .card h2{
    font-size:20px; margin:0 0 20px 0; color:var(--accent); 
    font-weight:600; border-bottom:2px solid #e2e8f0; padding-bottom:8px;
  }
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media (max-width:768px){ .grid{grid-template-columns:1fr} }
  label{
    display:block; margin-bottom:12px; font-size:14px; font-weight:500; color:var(--text);
  }
  label .label-text{display:block; margin-bottom:6px}
  input[type="number"], input[type="text"], select{
    width:100%; padding:12px 16px; border:2px solid var(--line); border-radius:8px; 
    background:white; color:var(--text); outline:none; font-size:14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  input:focus, select:focus{
    border-color:var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }
  input::placeholder{color:var(--muted)}
  .help{font-size:13px; color:var(--muted); margin-top:4px}
  .muted{color:var(--muted); font-size:13px; margin-top:6px}
  .pill{
    display:inline-block; padding:4px 8px; border-radius:12px; 
    background:#e0f2fe; color:#0369a1; font-size:11px; font-weight:600;
    margin-left:8px;
  }
  .btn{
    padding:14px 20px; border-radius:10px; border:none; 
    background:linear-gradient(135deg, var(--accent) 0%, #1d4ed8 100%);
    color:white; font-weight:600; cursor:pointer; font-size:14px;
    transition: all 0.2s ease; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{transform:translateY(-1px); box-shadow: 0 8px 25px rgba(59,130,246,0.3)}
  .btn.secondary{
    background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
  }
  .btn.secondary:hover{box-shadow: 0 8px 25px rgba(107,114,128,0.3)}
  .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:20px}
  .result{
    background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
    border:2px dashed var(--accent); border-radius:12px; padding:20px;
  }
  .result h3{margin:0 0 16px 0; color:var(--accent); font-size:18px}
  .kv{
    display:grid; grid-template-columns: 1fr auto; gap:16px; padding:12px 0; 
    border-bottom:1px solid #e2e8f0;
  }
  .kv:last-child{border-bottom:none}
  .kv .k{color:var(--muted); font-weight:500}
  .kv .v{font-weight:700; color:var(--text)}
  .ok{color:var(--green)} .warn{color:var(--yellow)} .err{color:var(--red)}
  .footer-note{
    opacity:0.8; font-size:13px; color:var(--muted); 
    background:#fef3c7; padding:12px; border-radius:8px; border-left:4px solid var(--yellow);
  }
  .chip{
    font-size:12px; padding:6px 10px; border-radius:20px; 
    border:1px solid var(--line); background:var(--hover); color:var(--text);
    font-weight:500;
  }
  details{
    background:#f8fafc; border:1px solid var(--line); border-radius:10px; 
    padding:16px; margin:16px 0;
  }
  details summary{
    cursor:pointer; user-select:none; font-weight:600; color:var(--accent);
    padding:8px 0;
  }
  details[open] summary{border-bottom:1px solid var(--line); margin-bottom:16px; padding-bottom:12px}
  .spacer{height:16px}
  .export-bar{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
  .notice{
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border: 1px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 24px;
    border-left: 4px solid var(--green);
  }
  .notice h3{margin: 0 0 12px 0; color: var(--green); font-size: 16px}
  .notice p{margin: 8px 0; line-height: 1.6; color: #065f46}
  .methodology{
    background: #fefce8; border: 1px solid #eab308; border-radius: 10px; 
    padding: 16px; margin-top: 16px; border-left: 4px solid var(--yellow);
  }
  .methodology h4{margin: 0 0 12px 0; color: #92400e; font-size: 14px}
  .methodology ul{margin: 8px 0; padding-left: 20px; color: #92400e}
  .methodology li{margin: 4px 0; line-height: 1.5}
</style>
</head>
<body>
<header>
  <div class="title">
    <h1>Calculateur d'√©chantillon d'audit</h1>
    <span class="badge">Mono-fichier ‚Ä¢ Responsive</span>
    <span class="badge">Techniques : MUS / Al√©atoire / Discovery</span>
  </div>
</header>
 
<main>
  <!-- Param√®tres principaux -->
  <section class="card">
    <h2>Param√®tres de la population</h2>
    
    <div class="notice">
      <h3>üéØ Aide-m√©moire m√©thodologique</h3>
      <p><strong>Cet outil calcule la taille d'√©chantillon optimale</strong> selon les techniques d'audit statistique reconnues : MUS/PPS, √©chantillonnage al√©atoire et discovery sampling.</p>
      <p><strong>Important :</strong> Les param√®tres et seuils doivent √™tre valid√©s par votre cabinet. Le jugement professionnel reste indispensable pour l'interpr√©tation des r√©sultats.</p>
    </div>

    <div class="grid">
      <div>
        <label>
          <span class="label-text">Valeur de la population (‚Ç¨)</span>
          <input id="population" type="number" min="0" step="0.01" placeholder="ex. 10 000 000" />
        </label>
      </div>
      <div>
        <label>
          <span class="label-text">Seuil/tolerable error (‚Ç¨)</span>
          <input id="tolerable" type="number" min="0" step="0.01" placeholder="ex. 250 000" />
        </label>
        <div class="muted">TER% = TE / Population (calcul√© automatiquement)</div>
      </div>
      <div>
        <label>
          <span class="label-text">Risque combin√© (CRA)</span>
          <select id="cra">
            <option value="VeryLow">Tr√®s faible</option>
            <option value="Low">Faible</option>
            <option value="LowerMed">Plut√¥t mod√©r√©</option>
            <option value="Medium" selected>Mod√©r√©</option>
            <option value="UpperMed">Plut√¥t √©lev√©</option>
            <option value="High">√âlev√©</option>
          </select>
        </label>
      </div>
      <div>
        <label>
          <span class="label-text">Assurance des autres proc√©dures subst.</span>
          <select id="aosp">
            <option value="Little" selected>Faible (Little)</option>
            <option value="Some">Mod√©r√©e (Some)</option>
            <option value="Corroborative">Corroborative</option>
            <option value="Persuasive">Probante (Persuasive)</option>
          </select>
        </label>
      </div>
      <div>
        <label>
          <span class="label-text">Technique d'√©chantillonnage</span>
          <select id="technique">
            <option value="MUS" selected>MUS / PPS (‚Ç¨)</option>
            <option value="Random">Al√©atoire (unit√©s)</option>
            <option value="Discovery">Discovery</option>
          </select>
        </label>
      </div>
      <div>
        <label>
          <span class="label-text">Erreur attendue (EER %) <span class="pill">optionnel</span></span>
          <input id="eer" type="number" min="0" step="0.01" placeholder="ex. 0,30" />
        </label>
        <div class="muted">En % de la population (0 = aucune erreur anticip√©e)</div>
      </div>
    </div>
 
    <details>
      <summary>Key items et param√®tres avanc√©s</summary>
      <div class="grid">
        <div>
          <label>
            <span class="label-text">Key items ‚Äì nombre</span>
            <input id="keyCount" type="number" min="0" step="1" placeholder="ex. 5" />
          </label>
        </div>
        <div>
          <label>
            <span class="label-text">Key items ‚Äì montant total (‚Ç¨)</span>
            <input id="keyAmount" type="number" min="0" step="0.01" placeholder="ex. 1 500 000" />
          </label>
          <div class="muted">Ces √©l√©ments seront test√©s √† 100 %.</div>
        </div>

        <div>
          <label>
            <span class="label-text">Politique key items</span>
            <select id="policy">
              <option value="microstart" selected>MicroSTART-like (TE‚Ä≤ = TE)</option>
              <option value="conservative">Conservatrice (TE‚Ä≤ = TE ‚àí key)</option>
            </select>
          </label>
        </div>
        <div></div>
 
        <div class="random-only">
          <label>
            <span class="label-text">Nombre d'unit√©s (N) <span class="pill">al√©atoire</span></span>
            <input id="N" type="number" min="1" step="1" placeholder="ex. 12 000" />
          </label>
        </div>
        <div class="random-only">
          <label>
            <span class="label-text">Pr√©valence attendue p (0-1) <span class="pill">al√©atoire</span></span>
            <input id="p" type="number" min="0" max="1" step="0.001" placeholder="ex. 0,02" />
          </label>
          <div class="muted">Si vide, on utilisera p=0,5 (pire cas).</div>
        </div>
 
        <div class="mus-only">
          <label>
            <span class="label-text">Erreurs planifi√©es (m) <span class="pill">MUS</span></span>
            <input id="mErrors" type="number" min="0" step="1" placeholder="ex. 0" />
          </label>
        </div>
        <div class="mus-only">
          <label>
            <span class="label-text">Relative error % (si MUS > 0 erreurs)</span>
            <input id="relErr" type="number" min="0" step="0.01" placeholder="ex. 100 (par d√©faut)" />
          </label>
        </div>
 
        <div class="disc-only">
          <label>
            <span class="label-text">Taux d'occurrence tol√©rable DER (0-1) <span class="pill">Discovery</span></span>
            <input id="der" type="number" min="0" max="1" step="0.0001" placeholder="ex. 0,02" />
          </label>
        </div>
      </div>
      <div class="methodology">
        <h4>Politique des key items :</h4>
        <ul>
          <li><strong>MicroSTART-like</strong> : les key items sortent de la population P (P‚Ä≤ = P ‚àí key) mais n'affectent pas TE (TE‚Ä≤ = TE)</li>
          <li><strong>Conservatrice</strong> : les key items "consomment" le seuil ‚Üí TE‚Ä≤ = max(0, TE ‚àí montant key items)</li>
        </ul>
      </div>
    </details>
 
    <div class="actions">
      <button class="btn" id="calcBtn">üìä Calculer la taille d'√©chantillon</button>
      <button class="btn secondary" id="resetBtn">üîÑ R√©initialiser</button>
      <span id="terBadge" class="chip">TER% : ‚Äî</span>
      <span id="clBadge" class="chip">Confiance cible : ‚Äî</span>
    </div>
    <div id="alerts" class="muted"></div>
 
    <div class="export-bar">
      <button class="btn" id="csvBtn">üìÑ Exporter CSV</button>
      <button class="btn" id="pdfBtn">üìã Exporter PDF</button>
    </div>
  </section>
 
  <!-- R√©sultats -->
  <section class="card">
    <h2>R√©sultats</h2>
    <div class="result" id="resultBox">
      <h3>En attente des param√®tres‚Ä¶</h3>
      <p class="help">Renseigne les champs et clique sur <strong>Calculer</strong>.</p>
    </div>
    
    <details>
      <summary>Hypoth√®ses & m√©thode</summary>
      <div class="methodology">
        <h4>Bases m√©thodologiques :</h4>
        <ul>
          <li>La matrice <em>Risque combin√© √ó Assurance d'autres proc√©dures</em> fixe une <strong>confiance statistique cible</strong> (CL), convertie en <em>RIA = 1 ‚àí CL</em></li>
          <li><strong>MUS/PPS</strong> : intervalle mon√©taire <code>SI = TE‚Ä≤ / CF</code>, o√π <code>CF</code> d√©pend de RIA (tableau interpol√©). Taille <code>n = ceil(P‚Ä≤ / SI) = ceil(P‚Ä≤¬∑CF / TE‚Ä≤)</code></li>
          <li><strong>Al√©atoire</strong> : formule binomiale <code>n0 = Z¬≤¬∑p(1‚àíp)/d¬≤</code>, d'o√π <code>d = TER%</code> ; correction de population finie <code>n = n0 / (1 + (n0 ‚àí 1)/N‚Ä≤)</code></li>
          <li><strong>Discovery</strong> : <code>n = ceil( ln(1‚àíCL) / ln(1‚àíDER) )</code></li>
          <li><strong>Key items</strong> : test√©s √† 100 %, on calcule sur la population r√©siduelle <code>P‚Ä≤</code>. Selon la politique choisie : MicroSTART-like (<code>TE‚Ä≤ = TE</code>) ou conservatrice (<code>TE‚Ä≤ = TE ‚àí key</code>)</li>
        </ul>
      </div>
    </details>
    
    <div class="footer-note">
      ‚ö†Ô∏è Cet outil est un aide-m√©moire m√©thodologique. Le calibrage interne des seuils et niveaux de confiance doit √™tre valid√© par votre cabinet d'audit.
    </div>
  </section>
</main>
 
<script>
/* ---------- Utilitaires ---------- */
const fmtEuro = v => isFinite(v)? new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v):'‚Äî';
const fmt = v => isFinite(v)? new Intl.NumberFormat('fr-FR').format(v):'‚Äî';
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
function nearestZ(cl){
  const table = [
    [0.80,1.282],[0.85,1.440],[0.90,1.645],[0.95,1.960],[0.975,2.241],[0.98,2.326],[0.99,2.576]
  ];
  if (cl<=table[0][0]) return table[0][1];
  if (cl>=table[table.length-1][0]) return table[table.length-1][1];
  for(let i=0;i<table.length-1;i++){
    const [c1,z1]=table[i], [c2,z2]=table[i+1];
    if (cl>=c1 && cl<=c2){
      const t=(cl-c1)/(c2-c1);
      return z1+(z2-z1)*t;
    }
  }
}
/* CF (confidence factor) pour MUS en fonction de RIA (%) */
const CF_POINTS = [
  [20,2.1],[15,2.5],[10,3.0],[7.5,3.2],[5,3.5],[2.5,4.6],[1,5.9]
];
function cfFromRIA(riaPct){
  riaPct = clamp(riaPct, 0.5, 25);
  for(let i=0;i<CF_POINTS.length-1;i++){
    const [x1,y1]=CF_POINTS[i], [x2,y2]=CF_POINTS[i+1];
    if (riaPct>=x2 && riaPct<=x1){
      const t=(riaPct-x2)/(x1-x2);
      return y2+(y1-y2)*t;
    }
  }
  return CF_POINTS[0][1];
}
 
/* ---------- Matrice CRA √ó AOSP -> RIA (%) ---------- */
const CRA_LEVELS = ["VeryLow","Low","LowerMed","Medium","UpperMed","High"];
const AOSP_LEVELS = ["Little","Some","Corroborative","Persuasive"];
const RIA_BASE = { "VeryLow":15,"Low":12,"LowerMed":10,"Medium":7.5,"UpperMed":5,"High":2.5 };
const AOSP_ADJ = { "Little":0.0,"Some":2.5,"Corroborative":5.0,"Persuasive":7.5 };
function riaFromMatrix(cra,aosp){
  let ria = (RIA_BASE[cra] ?? 7.5) + (AOSP_ADJ[aosp] ?? 0);
  return clamp(ria, 1.0, 25.0);
}
 
/* ---------- Calculs ---------- */
function compute(){
  const population = +document.getElementById('population').value;
  const tolerable  = +document.getElementById('tolerable').value;
  const cra = document.getElementById('cra').value;
  const aosp = document.getElementById('aosp').value;
  const technique = document.getElementById('technique').value;
  const policy = document.getElementById('policy').value;
 
  const eerPct = (document.getElementById('eer').value === '' ? null : +document.getElementById('eer').value);
  const keyCount = (document.getElementById('keyCount').value === '' ? 0 : +document.getElementById('keyCount').value);
  const keyAmount = (document.getElementById('keyAmount').value === '' ? 0 : +document.getElementById('keyAmount').value);
 
  const N = (document.getElementById('N').value === '' ? null : +document.getElementById('N').value);
  const p = (document.getElementById('p').value === '' ? 0.5 : +document.getElementById('p').value);
 
  const mErrors = (document.getElementById('mErrors').value === '' ? 0 : +document.getElementById('mErrors').value);
  const relErr = (document.getElementById('relErr').value === '' ? 100 : +document.getElementById('relErr').value);
 
  const der = (document.getElementById('der').value === '' ? null : +document.getElementById('der').value);
 
  const alerts = [];
 
  if (!(population>0)) alerts.push("Veuillez saisir une valeur de population > 0.");
  if (!(tolerable>0)) alerts.push("Veuillez saisir un seuil/tolerable error > 0.");
  if (keyAmount<0 || keyCount<0) alerts.push("Key items : valeurs n√©gatives non admises.");
  if (keyAmount>population) alerts.push("Le montant des key items ne peut pas exc√©der la population.");
  const terPct = (population>0 && tolerable>=0) ? (100*tolerable/population) : NaN;
 
  // Politique key items
  const Pp = Math.max(0, population - keyAmount);
  const TEp = (policy === 'conservative') ? Math.max(0, tolerable - keyAmount) : tolerable;
  
  if (Pp===0) alerts.push("Population r√©siduelle P‚Ä≤ = 0 (tous les √©l√©ments seraient en key items).");
  if (policy === 'conservative' && TEp === 0) alerts.push("Seuil r√©siduel TE‚Ä≤ = 0 avec la politique conservatrice : impossible de calculer n (r√©duisez les key items ou augmentez le seuil).");
 
  // RIA et CL
  const riaPct = riaFromMatrix(cra,aosp);
  let CL = 1 - riaPct/100;
 
  // Badges TER/CL
  document.getElementById('terBadge').textContent = isFinite(terPct) ? `TER% : ${terPct.toFixed(2)} %` : "TER% : ‚Äî";
  document.getElementById('clBadge').textContent = `Confiance cible : ${(CL*100).toFixed(1)} %`;
 
  // Ajustements MUS par EER/m
  const eerRatio = (eerPct!=null && population>0) ? (Math.max(0, eerPct)/ (100* tolerable/population)) : 0;
 
  let out = {technique, P:population, TE:tolerable, Pp, TEp, riaPct, CL, terPct, keyCount, keyAmount, policy};
  if (alerts.length){
    renderResult(out, alerts);
    window._lastReport = buildReportObject(out, alerts);
    return;
  }
 
  if (technique === "MUS"){
    let CF = cfFromRIA(riaPct);
    if (eerPct!=null && eerPct>0){
      const alpha = 0.8;
      CF = CF * (1 + alpha * eerRatio);
      out.notes = [`P√©nalit√© MUS pour erreur attendue : CF √ó (1 + ${alpha} √ó EER/TER).`];
    }
    if (mErrors>0){
      const delta = Math.min(1.0, 0.3*mErrors);
      CF = CF + delta;
      out.notes = [...(out.notes||[]), `Majoration CF pour erreurs planifi√©es (m=${mErrors}) : +${delta.toFixed(2)}.`];
    }
    const SI = TEp/CF;
    const n = (SI>0 && Pp>0) ? Math.ceil(Pp / SI) : NaN;
    Object.assign(out,{CF,SI,n, eerPct, mErrors, relErr});
    renderResult(out, alerts);
  }
  else if (technique === "Random"){
    if (!(N>0)) alerts.push("Veuillez renseigner N (nombre d'unit√©s) pour l'al√©atoire.");
    if (!(p>=0 && p<=1)) alerts.push("p (pr√©valence) doit √™tre entre 0 et 1.");
    const Z = nearestZ(CL);
    const d = terPct/100;
    const Np = Math.max(1, (N||1) - (keyCount||0));
    const n0 = (Z*Z * p*(1-p)) / (d*d);
    const n = n0 / (1 + (n0 - 1)/Np);
    Object.assign(out,{Z,d,p,N,Np,n0, n:Math.ceil(n)});
    renderResult(out, alerts);
  }
  else if (technique === "Discovery"){
    if (!(der>0 && der<1)) alerts.push("DER (taux tol√©rable) doit √™tre entre 0 et 1 pour Discovery.");
    const n = Math.ceil( Math.log(1-CL) / Math.log(1-der) );
    Object.assign(out,{DER:der, n});
    renderResult(out, alerts);
  }
 
  window._lastReport = buildReportObject(out, alerts);
}
 
function renderResult(o, alerts){
  const box = document.getElementById('resultBox');
  const warn = [];
  if (o.TEp===0) warn.push("TE‚Ä≤ = 0 ‚Üí impossible de calculer (div/0).");
  const cls = alerts.length? 'err' : (warn.length? 'warn' : 'ok');
  let html = `<h3>R√©sultat ‚Ä¢ <span class="${cls}">${o.technique}</span></h3>`;
  if (alerts.length){
    html += `<p class="err"><strong>V√©rifications requises :</strong><br>${alerts.map(a=>`‚Ä¢ ${a}`).join('<br>')}</p>`;
  }
  html += `<div class="kv"><div class="k">Population (P)</div><div class="v">${fmtEuro(o.P)}</div></div>`;
  html += `<div class="kv"><div class="k">Seuil tol√©rable (TE)</div><div class="v">${fmtEuro(o.TE)}</div></div>`;
  html += `<div class="kv"><div class="k">Key items (nb / ‚Ç¨)</div><div class="v">${fmt(o.keyCount||0)} / ${fmtEuro(o.keyAmount||0)}</div></div>`;
  html += `<div class="kv"><div class="k">Politique key items</div><div class="v">${o.policy==='microstart'?'MicroSTART-like (TE‚Ä≤ = TE)':'Conservatrice (TE‚Ä≤ = TE ‚àí key)'}</div></div>`;
  html += `<div class="kv"><div class="k">Population r√©siduelle (P‚Ä≤)</div><div class="v">${fmtEuro(o.Pp)}</div></div>`;
  html += `<div class="kv"><div class="k">Seuil r√©siduel (TE‚Ä≤)</div><div class="v">${fmtEuro(o.TEp)}</div></div>`;
  html += `<div class="kv"><div class="k">RIA cible (1‚àíCL)</div><div class="v">${o.riaPct?.toFixed(2)} %</div></div>`;
  html += `<div class="kv"><div class="k">Confiance statistique (CL)</div><div class="v">${(o.CL*100)?.toFixed(1)} %</div></div>`;
 
  if (o.technique==="MUS"){
    html += `<div class="kv"><div class="k">Confidence factor (CF)</div><div class="v">${o.CF?o.CF.toFixed(2):'‚Äî'}</div></div>`;
    html += `<div class="kv"><div class="k">Intervalle mon√©taire (SI)</div><div class="v">${isFinite(o.SI)?fmtEuro(o.SI):'‚Äî'}</div></div>`;
    html += `<div class="kv"><div class="k">Taille d'√©chantillon (n)</div><div class="v">${isFinite(o.n)?fmt(o.n):'‚Äî'}</div></div>`;
  } else if (o.technique==="Random"){
    html += `<div class="kv"><div class="k">N (apr√®s retrait key items)</div><div class="v">${fmt(o.Np||0)}</div></div>`;
    html += `<div class="kv"><div class="k">Pr√©cision cible d = TER%</div><div class="v">${(o.d*100).toFixed(2)} %</div></div>`;
    html += `<div class="kv"><div class="k">Statistique Z</div><div class="v">${o.Z?.toFixed(3)}</div></div>`;
    html += `<div class="kv"><div class="k">Taille d'√©chantillon (n)</div><div class="v">${isFinite(o.n)?fmt(o.n):'‚Äî'}</div></div>`;
  } else if (o.technique==="Discovery"){
    html += `<div class="kv"><div class="k">DER (taux d'occurrence tol√©rable)</div><div class="v">${(o.DER*100).toFixed(3)} %</div></div>`;
    html += `<div class="kv"><div class="k">Taille d'√©chantillon (n)</div><div class="v">${isFinite(o.n)?fmt(o.n):'‚Äî'}</div></div>`;
  }
  if (o.notes?.length){
    html += `<div class="muted" style="margin-top:8px">${o.notes.map(t=>`‚Ä¢ ${t}`).join('<br>')}</div>`;
  }
  box.innerHTML = html;
}
 
/* --------- Construction d'un rapport exploitable (pour CSV/PDF) --------- */
function buildReportObject(out, alerts){
  const now = new Date();
  const base = {
    timestamp: now.toISOString(),
    technique: out.technique,
    policy: out.policy,
    population: out.P, tolerable: out.TE,
    key_items_count: out.keyCount||0, key_items_amount: out.keyAmount||0,
    population_residuelle: out.Pp, seuil_residuel: out.TEp,
    ria_pct: out.riaPct, cl_pct: (out.CL*100),
    alerts: alerts.slice()
  };
  if (out.technique === "MUS"){
    Object.assign(base,{
      CF: out.CF, SI: out.SI, n: out.n,
      eer_pct: out.eerPct ?? null, planned_errors: out.mErrors ?? null, relative_error_pct: out.relErr ?? null
    });
  } else if (out.technique === "Random"){
    Object.assign(base,{
      N_total: out.N ?? null, N_apres_key: out.Np ?? null,
      p: out.p ?? null, Z: out.Z ?? null, precision_d: out.d ?? null, n: out.n
    });
  } else if (out.technique === "Discovery"){
    Object.assign(base,{
      DER: out.DER ?? null, n: out.n
    });
  }
  return base;
}
 
/* ---------- Export CSV ---------- */
function exportCSV(){
  const rep = window._lastReport;
  if (!rep){ alert("Veuillez d'abord calculer un r√©sultat."); return; }
  const headers = Object.keys(rep);
  const csvLine = headers.map(h=>{
    const v = rep[h];
    if (v==null) return '';
    if (typeof v === 'string' && v.includes(',')) return `"${v.replace(/"/g,'""')}"`;
    return v;
  }).join(',');
  const csv = headers.join(',') + '\n' + csvLine + '\n';
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const stamp = new Date().toISOString().split('T')[0];
  a.download = `sample_size_${rep.technique}_${stamp}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
 
/* ---------- Export PDF (fen√™tre d'impression d√©di√©e) ---------- */
function exportPDF(){
  const rep = window._lastReport;
  if (!rep){ alert("Veuillez d'abord calculer un r√©sultat."); return; }
 
  const style = `
  <style>
    body{font-family: Arial, system-ui; margin:24px; color:#111}
    h1{font-size:20px; margin:0 0 8px 0}
    h2{font-size:16px; margin:18px 0 8px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #ccc; padding:8px; font-size:12px}
    th{background:#f3f6fb; text-align:left}
    .muted{color:#555}
    @page{size: A4; margin:16mm}
    .small{font-size:11px}
  </style>`;
  const rows = Object.entries(rep).map(([k,v])=>{
    let label = k.replaceAll('_',' ').replace(/\b\w/g,m=>m.toUpperCase());
    if (k==='timestamp'){ label='Horodatage'; }
    if (k==='technique'){ label='Technique'; }
    if (k==='policy'){ label='Politique Key Items'; }
    return `<tr><th>${label}</th><td>${v==null?'':v}</td></tr>`;
  }).join('');
 
  const html = `
  <html><head><meta charset="utf-8">${style}</head>
  <body>
    <h1>Rapport de calcul ‚Äì Taille d'√©chantillon</h1>
    <div class="small muted">G√©n√©r√© le ${new Date().toLocaleString('fr-FR')}</div>
    <h2>Param√®tres & R√©sultats</h2>
    <table>${rows}</table>
    <p class="small muted">Astuce : utilisez ¬´ Enregistrer au format PDF ¬ª dans la bo√Æte de dialogue d'impression.</p>
  </body></html>`;
 
  const w = window.open('', '_blank', 'width=900,height=700');
  if (!w){ alert('Le bloqueur de fen√™tres a emp√™ch√© l\'ouverture. Autorisez les pop-ups pour ce site.'); return; }
  w.document.open(); w.document.write(html); w.document.close();
  setTimeout(()=>{ w.focus(); w.print(); }, 300);
}
 
/* ---------- UI comportements ---------- */
function syncVisibility(){
  const technique = document.getElementById('technique').value;
  document.querySelectorAll('.random-only').forEach(el=>el.style.display = (technique==='Random')?'block':'none');
  document.querySelectorAll('.mus-only').forEach(el=>el.style.display = (technique==='MUS')?'block':'none');
  document.querySelectorAll('.disc-only').forEach(el=>el.style.display = (technique==='Discovery')?'block':'none');
}
document.getElementById('technique').addEventListener('change', syncVisibility);
syncVisibility();
 
document.getElementById('calcBtn').addEventListener('click', compute);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.querySelectorAll('input').forEach(i=>i.value='');
  document.getElementById('cra').value='Medium';
  document.getElementById('aosp').value='Little';
  document.getElementById('technique').value='MUS';
  document.getElementById('policy').value='microstart';
  syncVisibility();
  document.getElementById('resultBox').innerHTML='<h3>En attente des param√®tres‚Ä¶</h3><p class="help">Renseigne les champs et clique sur <strong>Calculer</strong>.</p>';
  document.getElementById('terBadge').textContent='TER% : ‚Äî';
  document.getElementById('clBadge').textContent='Confiance cible : ‚Äî';
  document.getElementById('alerts').textContent='';
  window._lastReport = null;
});
['population','tolerable'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    const population = +document.getElementById('population').value;
    const tolerable  = +document.getElementById('tolerable').value;
    const terPct = (population>0 && tolerable>=0) ? (100*tolerable/population) : NaN;
    document.getElementById('terBadge').textContent = isFinite(terPct)? `TER% : ${terPct.toFixed(2)} %` : 'TER% : ‚Äî';
  });
});
 
document.getElementById('csvBtn').addEventListener('click', exportCSV);
document.getElementById('pdfBtn').addEventListener('click', exportPDF);
</script>
</body>
</html>
